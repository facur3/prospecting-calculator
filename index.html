<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prospecting Calculator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- THEME CONFIG --- */
        :root {
            --bg-app: #09090b;       /* Zinc 950 */
            --bg-panel: #18181b;     /* Zinc 900 */
            --bg-hover: #27272a;     /* Zinc 800 */
            --border: #27272a;       /* Zinc 800 */
            
            --text-main: #f4f4f5;    /* Zinc 100 */
            --text-muted: #a1a1aa;   /* Zinc 400 */
            --text-dim: #52525b;     /* Zinc 600 */

            --accent: #3b82f6;       /* Blue 500 */
            
            /* Rarities */
            --r-common: #9ca3af;
            --r-uncommon: #34d399;
            --r-rare: #60a5fa;
            --r-epic: #a78bfa;
            --r-legendary: #fbbf24;
            --r-mythic: #f472b6;
            --r-exotic: #ef4444;
        }

        * { box-sizing: border-box; outline: none; }
        
        body {
            margin: 0;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: var(--bg-app);
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
            display: flex;
            font-size: 14px;
        }

        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-dim); }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 300px;
            background-color: var(--bg-app);
            border-right: 1px solid var(--border);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 2rem;
            flex-shrink: 0;
            z-index: 10;
        }

        .brand {
            font-size: 1.1rem;
            font-weight: 700;
            letter-spacing: -0.02em;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }
        .brand svg { width: 24px; height: 24px; fill: var(--accent); }

        .controls-wrapper {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            overflow-y: auto;
        }

        .control-group { display: flex; flex-direction: column; gap: 0.6rem; }

        label {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        input, select {
            background-color: var(--bg-panel);
            border: 1px solid var(--border);
            color: var(--text-main);
            padding: 0.75rem;
            border-radius: 6px;
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            width: 100%;
        }

        input:focus, select:focus {
            border-color: var(--text-muted);
            background-color: var(--bg-hover);
        }

        input[type="number"] { font-family: 'JetBrains Mono', monospace; }

        /* --- HIDE SPINNERS --- */
        input[type=number]::-webkit-outer-spin-button,
        input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }

        /* --- MAIN CONTENT --- */
        .main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        /* --- TABLE --- */
        .table-container {
            flex-grow: 1;
            overflow-y: auto;
            padding: 0; 
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        th {
            text-align: left;
            padding: 1rem 1.5rem;
            color: var(--text-muted);
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            background-color: var(--bg-app);
            z-index: 5;
            white-space: nowrap;
        }

        td {
            padding: 0.85rem 1.5rem;
            border-bottom: 1px solid var(--border);
            vertical-align: middle;
            transition: background 0.15s;
        }

        tr:hover td { background-color: var(--bg-hover); }

        /* --- HIGHLIGHT BEST ROW (NUEVO) --- */
        .row-best {
            background: linear-gradient(90deg, rgba(234, 179, 8, 0.15) 0%, transparent 80%);
        }
        .row-best td {
            border-top: 1px solid rgba(234, 179, 8, 0.2);
            border-bottom: 1px solid rgba(234, 179, 8, 0.2);
        }
        .row-best td:first-child {
            border-left: 3px solid var(--r-legendary); /* Gold border indicator */
        }
        
        .best-badge {
            display: inline-block;
            background-color: var(--r-legendary);
            color: #000;
            font-size: 0.6rem;
            font-weight: 800;
            padding: 2px 6px;
            border-radius: 4px;
            margin-right: 8px;
            letter-spacing: 0.05em;
            vertical-align: middle;
        }

        /* --- TYPOGRAPHY & BADGES --- */
        .location-tag {
            color: var(--text-muted);
            font-weight: 500;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        /* En la fila ganadora, el texto de ubicacion brilla un poco */
        .row-best .location-tag { color: var(--text-main); font-weight: 600; }

        .mineral-name {
            font-weight: 600;
            font-size: 0.95rem;
            color: var(--text-main);
            text-decoration: none;
        }
        .mineral-name:hover { color: var(--accent); }

        .badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.2rem 0.6rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            min-width: 75px;
            background: rgba(255,255,255,0.05);
        }

        /* Rarity Colors */
        .type-common { color: var(--r-common); border: 1px solid rgba(156, 163, 175, 0.3); }
        .type-uncommon { color: var(--r-uncommon); border: 1px solid rgba(52, 211, 153, 0.3); }
        .type-rare { color: var(--r-rare); border: 1px solid rgba(96, 165, 250, 0.3); }
        .type-epic { color: var(--r-epic); border: 1px solid rgba(167, 139, 250, 0.3); }
        .type-legendary { color: var(--r-legendary); border: 1px solid rgba(251, 191, 36, 0.3); }
        .type-mythic { color: var(--r-mythic); border: 1px solid rgba(244, 114, 182, 0.3); }
        .type-exotic { 
            color: var(--r-exotic); 
            border: 1px solid rgba(239, 68, 68, 0.5);
            box-shadow: 0 0 12px rgba(239, 68, 68, 0.2);
        }

        .val-text { font-family: 'JetBrains Mono', monospace; color: var(--text-muted); font-size: 0.85rem; }
        
        /* Bateas / Effort Column */
        .prob-cell { display: flex; flex-direction: column; align-items: flex-end; justify-content: center; }
        
        .batches-count { 
            font-family: 'JetBrains Mono', monospace; 
            font-weight: 700; 
            font-size: 1.25rem; 
            color: var(--text-main);
            line-height: 1.1;
        }
        
        .batches-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 2px;
        }

        .prob-sub { 
            font-family: 'JetBrains Mono', monospace; 
            font-size: 0.7rem; 
            color: var(--text-dim); 
            margin-top: 2px;
        }

        .effort-easy { color: var(--r-uncommon); }
        .effort-mid { color: var(--accent); }
        .effort-hard { color: var(--r-legendary); }
        .effort-insane { color: var(--r-exotic); }

        /* --- ERROR OVERLAY --- */
        #error-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-app);
            display: none;
            justify-content: center; align-items: center;
            z-index: 100;
        }
        .error-box { text-align: center; padding: 2rem; border: 1px solid var(--r-exotic); border-radius: 8px; background: var(--bg-panel); }
        .error-box h2 { color: var(--r-exotic); margin: 0 0 1rem 0; }

        /* --- RESPONSIVE --- */
        @media (max-width: 768px) {
            body { flex-direction: column; overflow: auto; }
            .sidebar { width: 100%; height: auto; border-right: none; border-bottom: 1px solid var(--border); }
            .table-container { overflow-x: auto; }
        }
    </style>
</head>
<body>

    <div id="error-overlay">
        <div class="error-box">
            <h2>Error de Base de Datos</h2>
            <p>No se encuentra <code>database.js</code>.</p>
        </div>
    </div>

    <script src="database.js" onerror="document.getElementById('error-overlay').style.display='flex'"></script>

    <aside class="sidebar">
        <div class="brand">
            <svg viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5zm0 9l2.5-1.25L12 8.5l-2.5 1.25L12 11zm0 2.5l-5-2.5-5 2.5L12 22l10-8.5-5-2.5-5 2.5z"/></svg>
            PROSPECTING CALCULATOR
        </div>

        <div class="controls-wrapper">
            <div class="control-group">
                <label for="zoneSelect">Zona / Ubicaci칩n</label>
                <select id="zoneSelect">
                    <option value="all">游깴 Todas las Ubicaciones</option>
                </select>
            </div>

            <div class="control-group">
                <label for="search">Filtrar Mineral</label>
                <input type="text" id="search" placeholder="Ej: Diamond, Gold...">
            </div>

            <div style="height: 1px; background: var(--border); margin: 0.5rem 0;"></div>

            <div class="control-group">
                <label for="luck">Suerte (Luck Multiplier)</label>
                <input type="number" id="luck" value="1" min="0.1" step="0.1">
            </div>

            <div class="control-group">
                <label for="capacity">Capacidad Batea</label>
                <input type="number" id="capacity" value="50" min="1">
            </div>
        </div>
    </aside>

    <main class="main-content">
        <div class="table-container">
            <table id="resultsTable">
                <thead>
                    <tr>
                        <th style="width: 18%">Ubicaci칩n</th>
                        <th style="width: 20%">Mineral</th>
                        <th style="width: 15%">Rareza</th>
                        <th style="width: 15%; text-align: right;">Valor</th>
                        <th style="width: 15%; text-align: right;">Base (1 en X)</th>
                        <th style="width: 17%; text-align: right;">Esfuerzo Estimado</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
            <div id="no-results" style="text-align: center; padding: 4rem; color: var(--text-dim); display: none;">
                No se encontraron resultados con estos par치metros.
            </div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof scrapedDatabase === 'undefined') {
                document.getElementById('error-overlay').style.display = 'flex';
                return;
            }

            const state = {
                zone: 'all',
                search: '',
                luck: 1,
                capacity: 50
            };

            const ui = {
                zoneSelect: document.getElementById('zoneSelect'),
                searchInput: document.getElementById('search'),
                luckInput: document.getElementById('luck'),
                capInput: document.getElementById('capacity'),
                tableBody: document.querySelector('#resultsTable tbody'),
                noResults: document.getElementById('no-results')
            };

            function init() {
                populateZones();
                renderTable();
                setupListeners();
            }

            function populateZones() {
                const zones = Object.keys(scrapedDatabase).sort();
                zones.forEach(zone => {
                    const option = document.createElement('option');
                    option.value = zone;
                    option.textContent = zone;
                    ui.zoneSelect.appendChild(option);
                });
            }

            function setupListeners() {
                ui.zoneSelect.addEventListener('change', (e) => { state.zone = e.target.value; renderTable(); });
                ui.searchInput.addEventListener('input', (e) => { state.search = e.target.value.toLowerCase(); renderTable(); });
                ui.luckInput.addEventListener('input', (e) => { state.luck = parseFloat(e.target.value) || 1; renderTable(); });
                ui.capInput.addEventListener('input', (e) => { state.capacity = parseInt(e.target.value) || 1; renderTable(); });
            }

            function calculateChance(baseOneIn) {
                let adjustedOneIn = baseOneIn / state.luck;
                if (adjustedOneIn < 1) adjustedOneIn = 1;
                const pIndividual = 1 / adjustedOneIn;
                return 1 - Math.pow((1 - pIndividual), state.capacity);
            }

            function formatMoney(val) {
                return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(val);
            }

            function renderTable() {
                ui.tableBody.innerHTML = '';

                let rawData = [];
                
                if (state.zone === 'all') {
                    Object.entries(scrapedDatabase).forEach(([zoneName, minerals]) => {
                        const mineralsWithLoc = minerals.map(m => ({ ...m, location: zoneName }));
                        rawData = rawData.concat(mineralsWithLoc);
                    });
                } else {
                    const minerals = scrapedDatabase[state.zone] || [];
                    rawData = minerals.map(m => ({ ...m, location: state.zone }));
                }

                let filtered = rawData.filter(item => 
                    item.name.toLowerCase().includes(state.search)
                );

                if (filtered.length === 0) {
                    ui.noResults.style.display = 'block';
                    return;
                }
                ui.noResults.style.display = 'none';

                const processed = filtered.map(item => {
                    return {
                        ...item,
                        calcChance: calculateChance(item.oneIn)
                    };
                });

                // Ordenar: Los m치s f치ciles arriba
                processed.sort((a, b) => b.calcChance - a.calcChance);

                const fragment = document.createDocumentFragment();

                processed.forEach((item, index) => {
                    const tr = document.createElement('tr');
                    
                    // --- DETECCION DE MEJOR FILA (PRIMERA) ---
                    let locationHTML = item.location;
                    if (index === 0) {
                        tr.classList.add('row-best');
                        locationHTML = `<span class="best-badge">游끥 MEJOR ZONA</span> ${item.location}`;
                    }

                    // --- L칍GICA DE ESFUERZO (BATEAS) ---
                    const chance = item.calcChance;
                    let batchesStr = "";
                    let percentStr = "";
                    let effortClass = "effort-mid";

                    const avgBatches = 1 / chance;

                    if (chance >= 0.99) {
                        batchesStr = "1"; 
                        percentStr = "Garantizado";
                        effortClass = "effort-easy";
                    } else {
                        if (avgBatches > 10000) effortClass = "effort-insane";
                        else if (avgBatches > 1000) effortClass = "effort-hard";
                        else if (avgBatches < 50) effortClass = "effort-easy";
                        
                        batchesStr = Math.ceil(avgBatches).toLocaleString();
                        percentStr = (chance * 100).toFixed(3) + "%";
                    }

                    const rarityClass = `type-${item.type.toLowerCase()}`;

                    tr.innerHTML = `
                        <td>
                            <div class="location-tag">
                                ${index !== 0 ? '<span>游늸</span>' : ''} ${locationHTML}
                            </div>
                        </td>
                        <td>
                            <a href="${item.wikiUrl}" target="_blank" class="mineral-name">${item.name}</a>
                        </td>
                        <td>
                            <span class="badge ${rarityClass}">${item.type}</span>
                        </td>
                        <td style="text-align: right;">
                            <span class="val-text">${formatMoney(item.value)}</span>
                        </td>
                        <td style="text-align: right;">
                            <span class="val-text">1 en ${item.oneIn.toLocaleString()}</span>
                        </td>
                        <td style="text-align: right;">
                            <div class="prob-cell">
                                <span class="batches-count ${effortClass}">${batchesStr}</span>
                                <span class="batches-label">Bateas</span>
                                <span class="prob-sub">${percentStr}</span>
                            </div>
                        </td>
                    `;
                    fragment.appendChild(tr);
                });

                ui.tableBody.appendChild(fragment);
            }

            init();
        });
    </script>
</body>
</html>